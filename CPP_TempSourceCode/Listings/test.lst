C51 COMPILER V9.60.0.0   TEST                                                              07/07/2022 13:20:49 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE TEST
OBJECT MODULE PLACED IN .\Objects\test.obj
COMPILER INVOKED BY: D:\Practice\C51\BIN\C51.EXE test.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND PRINT(.\Listings\tes
                    -t.lst) TABS(2) OBJECT(.\Objects\test.obj)

line level    source

   1          /* Main.c file generated by New Project wizard
   2           *
   3           * Created:   Mon May 16 2022
   4           * Processor: AT89C51
   5           * Compiler:  Keil for 8051
   6           */
   7          
   8          //#include <reg51.h>
   9          #include <stdio.h>
  10          #include <at89x51.h>
  11          
  12          #define sbl(_sfr, bit) (_sfr |= (1 << bit))
  13          #define cbl(_sfr, bit) (_sfr &= (~(1 << bit)))
  14          #define tbl(_sfr, bit) (_sfr ^= (1 << bit))
  15          #define red_time 10
  16          #define yellow_time 3
  17          #define start_phase 1
  18          
  19          int mode = 1;
  20          int ms = 0;
  21          int second = red_time;
  22          int phase = start_phase;
  23          int red = 3;
  24          int yellow = 2;
  25          int green = 1;
  26          void show_led_1(int time);
  27          void show_led_2(int time);
  28          void delay_10ms();
  29          void delay(int time);
  30          void phase_init();
  31          void phase_update();
  32          void phase_1();
  33          void phase_2();
  34          void phase_3();
  35          void phase_4();
  36          void phase_call();
  37          void red_on(int x)        {cbl(P3, x - 1);}
  38          void yellow_on(int x)     {cbl(P3, x + 3);}
  39          void green_on(int x)      {cbl(P3, x + 5);}
  40          void red_off(int x)       {sbl(P3, x - 1);}
  41          void yellow_off(int x)    {sbl(P3, x + 3);}
  42          void green_off(int x)     {sbl(P3, x + 5);}
  43          void stop_on(int x)       {cbl(P0, 2 * x - 2);}
  44          void walk_on(int x)       {cbl(P0, 2 * x - 1);}
  45          void stop_off(int x)      {sbl(P0, 2 * x - 2);}
  46          void walk_off(int x)      {sbl(P0, 2 * x - 1);}
  47          void toggle_yellow(int x) {tbl(P3, x + 3);}
  48          void toggle_walk(int x)   {tbl(P0, 2 * x - 1);}
  49          void phase_clear();
  50          void mode_1();
  51          void mode_2();
  52          
  53          void main(void) 
  54             { 
C51 COMPILER V9.60.0.0   TEST                                                              07/07/2022 13:20:49 PAGE 2   

  55   1            IE = 0x83;
  56   1            TMOD = 0x11;
  57   1            TCON = 0x01;
  58   1            TH0 = 0xFC;
  59   1            TL0 = 0x18;
  60   1            TR0 = 1;
  61   1            phase_init();
  62   1            while (1) {
  63   2                if (mode == 1) mode_1();
  64   2            }
  65   1         }
  66          
  67          void INT0_ISR() interrupt 0 {
  68   1            if (mode == 1) {
  69   2                phase_clear();
  70   2                ms = 0;
  71   2                mode = 2;
  72   2            }
  73   1            else {
  74   2                yellow_off(1);
  75   2                yellow_off(2);
  76   2                ms = 0;
  77   2                second = red_time;
  78   2                phase = 1;
  79   2                mode = 1;
  80   2                phase_init();       
  81   2            }
  82   1      }
  83             
  84          void Timer0_ISR() interrupt 1 
  85             {
  86   1            TR0 = 0;
  87   1            ms ++;
  88   1            if (mode == 1) {
  89   2                if (ms == 500 && second <= 6 && second >= 3) {
  90   3                    if (phase == 1) walk_on(1);
  91   3                    else if (phase == 3) walk_on(2);
  92   3                }
  93   2                if (ms == 1000) {
  94   3                    ms = 0;
  95   3                    second --;
  96   3                    if (second <= 6 && second >= 3) {
  97   4                      if (phase == 1) walk_off(1);
  98   4                      else if (phase == 3) walk_off(2);
  99   4                    }
 100   3                }
 101   2            }
 102   1            else {
 103   2                if (ms == 500) {
 104   3                  toggle_yellow(1);
 105   3                  toggle_yellow(2);
 106   3                  ms = 0;
 107   3                }
 108   2            }
 109   1            TH0 = 0xFC;
 110   1            TL0 = 0x18;
 111   1            TR0 = 1;
 112   1         }
 113             
 114          void show_led_1(int time) 
 115             {
 116   1            int a = time / 10, b = time % 10;
C51 COMPILER V9.60.0.0   TEST                                                              07/07/2022 13:20:49 PAGE 3   

 117   1            P1 = a;
 118   1            sbl(P1, 4);
 119   1            delay(10);
 120   1            cbl(P1, 4);
 121   1            P1 = b;
 122   1            sbl(P1, 5);
 123   1            delay(10);
 124   1            cbl(P1, 5);
 125   1         }
 126          
 127          void show_led_2(int time) 
 128             {
 129   1            int a = time / 10, b = time % 10;
 130   1            P2 = a;
 131   1            sbl(P2, 4);
 132   1            delay(10);
 133   1            cbl(P2, 4);
 134   1            P2 = b;
 135   1            sbl(P2, 5);
 136   1            delay(10);
 137   1            cbl(P2, 5);
 138   1         }
 139          
 140          void delay(int time) 
 141             {
 142   1            int i, n = time / 10;
 143   1            for (i = 0; i < n; ++ i) delay_10ms();
 144   1         }   
 145          
 146          void delay_10ms() 
 147             {
 148   1            TH1 = 0xD8;
 149   1            TL1 = 0xF0;
 150   1            TR1 = 1;
 151   1            while (!TF1);
 152   1            TR1 = 0;
 153   1            TF1 = 0;
 154   1         }
 155             
 156          void phase_init() {
 157   1          if (phase == 1) {
 158   2              red_on(1);
 159   2              walk_on(1);
 160   2              green_on(2);
 161   2              stop_on(2);
 162   2          }
 163   1          else if (phase == 2) {
 164   2              red_on(1);
 165   2              stop_on(1);
 166   2              yellow_on(2);
 167   2              stop_on(2);
 168   2          }
 169   1          else if (phase == 3) {
 170   2              green_on(1);
 171   2              stop_on(1); 
 172   2              red_on(2);
 173   2              walk_on(2);
 174   2          }
 175   1          else {
 176   2              yellow_on(1);
 177   2              stop_on(1);
 178   2              red_on(2);
C51 COMPILER V9.60.0.0   TEST                                                              07/07/2022 13:20:49 PAGE 4   

 179   2              stop_on(2);
 180   2          } 
 181   1      } 
 182          
 183          void phase_clear() {
 184   1          if (phase == 1) {
 185   2              red_off(1);
 186   2              walk_off(1);
 187   2              green_off(2);
 188   2              stop_off(2);
 189   2          }
 190   1          else if (phase == 2) {
 191   2              red_off(1);
 192   2              stop_off(1);
 193   2              yellow_off(2);
 194   2              stop_off(2);
 195   2          }
 196   1          else if (phase == 3) {
 197   2              green_off(1);
 198   2              stop_off(1);  
 199   2              red_off(2);
 200   2              walk_off(2);
 201   2          }
 202   1          else {
 203   2              yellow_off(1);
 204   2              stop_off(1);
 205   2              red_off(2);
 206   2              stop_off(2);
 207   2          }
 208   1      }
 209          
 210          
 211          void phase_update() {
 212   1            if (phase == 1) {
 213   2                if (second == yellow_time) {
 214   3                  phase = 2;
 215   3                  walk_off(1);
 216   3                  stop_on(1);
 217   3                  green_off(2);
 218   3                  yellow_on(2);
 219   3                }
 220   2            }
 221   1            else if (phase == 2) {
 222   2                if (second == 0) {
 223   3                  phase = 3;
 224   3                  second = red_time;
 225   3                  red_off(1);
 226   3                  yellow_off(2);
 227   3                  stop_off(2);
 228   3                  green_on(1);
 229   3                  red_on(2);
 230   3                  walk_on(2);
 231   3                }
 232   2            }
 233   1            else if (phase == 3) {
 234   2                if (second == yellow_time) {
 235   3                  phase = 4;
 236   3                  green_off(1);
 237   3                  yellow_on(1);
 238   3                  walk_off(2);
 239   3                  stop_on(2);
 240   3                }
C51 COMPILER V9.60.0.0   TEST                                                              07/07/2022 13:20:49 PAGE 5   

 241   2            }
 242   1            else {
 243   2                if (second == 0) {
 244   3                  phase = 1;
 245   3                  second = red_time;
 246   3                  yellow_off(1);
 247   3                  stop_off(1);
 248   3                  red_off(2);
 249   3                  red_on(1);
 250   3                  walk_on(1);
 251   3                  green_on(2);
 252   3                }
 253   2            }
 254   1      }
 255          
 256          void phase_1() {
 257   1            show_led_1(second);
 258   1            show_led_2(second - yellow_time);
 259   1      }
 260          
 261          void phase_2() {
 262   1            show_led_1(second);
 263   1            show_led_2(second);
 264   1      }
 265          
 266          void phase_3() {
 267   1            show_led_1(second - yellow_time);
 268   1            show_led_2(second);
 269   1      }
 270          
 271          void phase_4() {
 272   1            show_led_1(second);
 273   1            show_led_2(second);
 274   1      }
 275          
 276          void phase_call() {
 277   1            if (phase == 1) phase_1();
 278   1            else if (phase == 2) phase_2();
 279   1            else if (phase == 3) phase_3();
 280   1            else phase_4();
 281   1      }  
 282          
 283          void mode_1() {
 284   1            phase_update();
 285   1            phase_call();
 286   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   1224    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =     14       8
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
